<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="cordova.js"></script>
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="www/config.js"></script>

    <script>
let postsRef;
let postsListener = null;
let currentEditId = null;
let currentUser = null;
const likeCounts = {}; // å„æŠ•ç¨¿ã®ã€Œã„ã„ã­ã€ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

function showMessage(message, type = 'success') {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
    setTimeout(() => {
        messageArea.innerHTML = '';
    }, 3000);
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
    });
}

function toggleLike(postId, button) {
    if (!likeCounts[postId]) {
        likeCounts[postId] = 0;
    }

    button.classList.toggle('liked');

    if (button.classList.contains('liked')) {
        likeCounts[postId]++;
    } else {
        likeCounts[postId]--;
    }

    document.getElementById(`like-count-${postId}`).textContent = likeCounts[postId];
}

function createPostElement(post) {
    likeCounts[post.id] = likeCounts[post.id] || 0;

    const canEdit = currentUser && post.userId === currentUser.uid;
    const actions = canEdit ? `
        <div class="post-actions">
            <button class="btn-edit" onclick="startEdit('${post.id}')">ç·¨é›†</button>
            <button class="btn-delete" onclick="deletePost('${post.id}')">å‰Šé™¤</button>
        </div>
    ` : '';

    return `
        <div class="post" id="post-${post.id}">
            <div class="post-header">
                <span class="post-author">${escapeHtml(post.author)}</span>
                ${actions}
            </div>
            <div class="post-content">${escapeHtml(post.content)}</div>
            <div class="post-footer">
                <span class="post-time">${formatTimestamp(post.timestamp)}</span>
                <button class="like-button" onclick="toggleLike('${post.id}', this)">â¤ï¸ ã„ã„ã­</button>
                <span id="like-count-${post.id}">${likeCounts[post.id]}</span>
            </div>
        </div>
    `;
}

function renderPosts(posts) {
    const postsDiv = document.getElementById('postsList');
    postsDiv.innerHTML = '';

    if (posts.length === 0) {
        postsDiv.innerHTML = '<p class="no-posts">æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    posts.forEach(post => {
        postsDiv.insertAdjacentHTML('beforeend', createPostElement(post));
    });
}

function loadPosts() {
    const sortOrder = document.getElementById('sortOrder').value;
    document.getElementById('loadingSpinner').style.display = 'block';

    if (postsListener) {
        postsRef.off('value', postsListener);
        postsListener = null;
    }

    postsListener = postsRef.on('value', snapshot => {
        const posts = [];
        snapshot.forEach(childSnapshot => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val(),
            });
        });

        if (sortOrder === 'newest') {
            posts.sort((a, b) => b.timestamp - a.timestamp);
        } else {
            posts.sort((a, b) => a.timestamp - b.timestamp);
        }

        renderPosts(posts);
        document.getElementById('loadingSpinner').style.display = 'none';
    }, error => {
        console.error('Data fetch error:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        document.getElementById('loadingSpinner').style.display = 'none';
    });
}

function startEdit(postId) {
    currentEditId = postId;
    const postContent = document.querySelector(`#post-${postId} .post-content`).textContent;
    document.getElementById('editContent').value = postContent;
    showModal('editModal');
}

function handleUpdate() {
    if (!currentEditId) return;

    const content = document.getElementById('editContent').value;

    postsRef.child(currentEditId).update({
        content,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
    }).then(() => {
        showMessage('æŠ•ç¨¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        closeModal('editModal');
    }).catch(error => {
        showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
    });
}

function deletePost(postId) {
    postsRef.child(postId).remove()
        .then(() => {
            showMessage('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        })
        .catch(error => {
            showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
        });
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        firebase.initializeApp(firebaseConfig);
        postsRef = firebase.database().ref('posts');
    } catch (error) {
        console.error('Firebase initialization error:', error);
        showMessage('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }

    firebase.auth().onAuthStateChanged(user => {
        currentUser = user;
        loadPosts();
    });

    document.getElementById('postButton').addEventListener('click', () => {
        const content = document.getElementById('contentInput').value;

        if (!currentUser) {
            showMessage('æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
            return;
        }

        if (!content.trim()) {
            showMessage('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }

        postsRef.push({
            author: currentUser.email,
            content,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            userId: currentUser.uid,
        }).then(() => {
            showMessage('æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            document.getElementById('contentInput').value = '';
        }).catch(error => {
            showMessage('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
        });
    });

    document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
});
    </script>

<style>
.dark-mode {
    background-color: #121212;
    color: white;
}
.dark-mode .post {
    background-color: #1e1e1e;
    border-color: #333;
}
.post {
    border: 1px solid #ddd;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
}
.post-footer {
    margin-top: 10px;
}
.like-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    color: #333;
}
.like-button.liked {
    color: red;
}
</style>
</head>
<body>
    <div class="container">
        <h1>æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª</h1>
        <button id="darkModeToggle">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
        <div id="messageArea"></div>
        <div class="post-form">
            <textarea id="contentInput" placeholder="æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            <button id="postButton">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
        <select id="sortOrder">
            <option value="newest">æ–°ã—ã„é †</option>
            <option value="oldest">å¤ã„é †</option>
        </select>
        <div id="postsList"></div>
        <div id="loadingSpinner" style="display: none;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
</body>
</html>
